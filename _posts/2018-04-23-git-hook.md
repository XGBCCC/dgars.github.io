--
layout: post
title: git hook
category: tech
tag: git
--

###### 服务器钩子(push前 clang-format验证)
```
#!/bin/bash
# clang-format 的路径
# CLANG_FORMAT="/usr/local/bin/clang-format"

# 是否只验证需要匹配的文件
PARSE_EXTS=true

#匹配哪些文件
FILE_EXTS=".c .h .cpp .hpp .cc .hh .cxx .m"

#记录一个全局变量，来标记clang-format 检测结果
CLANG_FORMAT_CHECK_RESULT=""

# 强制提交标识符 不做clang-format校验
COMMIT_WITHOUT_CLANG_FORMAT_VERIFICATION="COMMIT_WITHOUT_CLANG_FORMAT_VERIFICATION"

#获取 git提交的 sha-1
read -a infos <<< $(cat)
old=${infos[0]}
new=${infos[1]}


#创建临时文件夹，用来存放clang-format后的文件
dir="tmp_clangformat"
mkdir ${dir}

#主要是为了解决while read line 再新的进程，导致更改全局变量不能传递过来的坑，改用文件做判断
errorFile="$dir/errorfile"

# 匹配文件后缀
matches_extension() {
    local filename=$(basename "$1")
    local extension=".${filename##*.}"
    local ext

    for ext in $FILE_EXTS; do [[ "$ext" == "$extension" ]] && return 0; done

    return 1
}


# 校验 文件合适是否正确
checkBlob() {
    echo "checkBoob 参数：$1,$2,$3"
    if [ ${2:0:1} == "\"" ] ; then
        echo "$2 文件名有误，可能是中文命名"
        CLANG_FORMAT_CHECK_RESULT="Error"
    else
        if $PARSE_EXTS && ! matches_extension "$2"; then
            echo "$2 文件格式不匹配，忽略"
        else
            echo "开始校验：$2"
            # 声明要存放的路径
            originFile="${dir}/tmp_originTmp.m"
            clangFormatFile="${dir}/cat.m"

            git cat-file blob $1 > $originFile
            clang-format -style=file $originFile > $clangFormatFile
            
            # 将两个文件进行比较
            if cmp -s $originFile $clangFormatFile
            then
                echo "$2    文件检验成功"
            else
                echo "$2    文件检验失败,请先用clang-format工具进行格式化"
                rm -f $originFile
                rm -f $clangFormatFile
                CLANG_FORMAT_CHECK_RESULT="Error"
            fi
        fi
    fi
    
}

# 解析sha1 得到正确的文件数据，然后传递给checkBlob
getBlob() {
    echo "解析sha1:$1"
    type=`git cat-file -t $1 | awk '{print $1}'`
    echo "sha1类型:$type"
    if [ "$type" = "tree" ];
    then
        echo "解析该sha1:$1"
        git cat-file -p $1 | while read info
        do
            echo "发现内容：$info"
            sha1=`echo "$info" | awk '{print $3}'`
            fileName=`echo "$info" | awk '{print $4}'`
            subType=`git cat-file -t $sha1 | awk '{print $1}'`
            if [ "$subType" = "tree" ];then
                echo "类型为tree，进行递归解析:$sha1"
                getBlob $sha1
            elif [ "$subType" = "blob" ]; then
                echo "类型为blob，进入checkBlob流程:$sha1"
                checkBlob $sha1 $fileName
                if [ ! "$CLANG_FORMAT_CHECK_RESULT" = "" ] ; then
                    echo "Error" > $errorFile
                    echo "得到格式校验失败的返回值，结束check循环"
                    break
                fi
            fi
        done
    elif [ "$type" = "blob" ];
    then
        echo "getBlob 参数传递错误，应该是tree对象"
    fi
}


# 检验clang-format 是否安装
command -v clang-format -version >/dev/null 2>&1 || { echo >&2 "clang-format 未安装"; exit 1; }

# 通过git对象，获取到更改后的文件内容
echo "找到commit:${new}"
# 获取commit 信息
commitMessage=`git log ${new} -n 1 --pretty='%s%b'`
echo "获取到commit message:${commitMessage}"
if [ $commitMessage = $COMMIT_WITHOUT_CLANG_FORMAT_VERIFICATION ]; then
    echo "发现特殊字符串，忽略clang-format直接进行提交"
    exit 0
fi
# 读取commit信息，获取到更新的tree
tree=`git cat-file -p ${new} | grep tree | awk '{print $2}'`
# 读取更新tree的信息
echo "找到commit对应的sha1:$tree"
# 读取commit 信息，如果读取到特殊的commit信息，则不进行校验，直接提交

getBlob $tree
    
    
# 检查结束
if [ -s "$errorFile" ] ; then
    rm -rf ${dir}
    echo "格式校验失败，done"
    exit 1
fi
# 校验完毕，可以提交
rm -rf ${dir}
echo "格式校验成功，done"
exit 0
```

